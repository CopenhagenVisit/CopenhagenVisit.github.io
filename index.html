<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Copenhagen Trip Planner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>

  <header class="app-header">
    <h1>üá©üá∞ Copenhagen Trip Planner</h1>
    <div class="controls">
      <button id="toggle-unassigned-btn">
        <i class="fas fa-lightbulb"></i> <!-- Fun icon -->
        <span>Show Mattia's Tips</span>
      </button>
    </div>
  </header>
  <div class="share-bar" id="share-bar">
      <label for="share-url-input">Your current share link:</label>
      <input type="text" id="share-url-input" readonly>
      <button id="copy-url-btn">
          <i class="fas fa-copy"></i> Copy
      </button>
      <span id="copy-confirmation" class="copy-confirm-inline"></span>
  </div>

  <main class="board-container" id="board">
    {/* Columns will be generated by JavaScript */}
    <div class="loading-state"><div class="spinner"></div> Loading...</div>
  </main>

  <script>
    // --- Configuration ---
    const WEATHERAPI_COM_KEY = "c44f7b2f35464bd480e230517240203"; // Your WeatherAPI.com Key
    const COPENHAGEN_LAT = 55.6761;
    const COPENHAGEN_LON = 12.5683;
    const TRIP_DATES = ["2025-04-16", "2025-04-17", "2025-04-18"];
    const HASH_PREFIX = "#boardState=";
    const INDEX_PAD_LENGTH = 2; // Use 2 digits for item index (00-99)
    const WEATHER_CACHE_KEY = 'copenhagenWeatherCache'; // Key for localStorage
    const CACHE_EXPIRY_MS = 60 * 60 * 1000; // 1 hour in milliseconds

    // --- Globals ---
    let allPlacesData = [];
    let placeIdToIndexMap = {}; // Map place.id -> index in allPlacesData
    let cardElements = {};
    const boardElement = document.getElementById('board');
    const toggleButton = document.getElementById('toggle-unassigned-btn');
    let isUnassignedVisible = false;
    const COLUMN_IDS_ORDER = ['unassigned', ...TRIP_DATES]; // Fixed order for saving/loading

    // --- Emoji Mapping & Category Class ---
    const categoryEmojis = { 'Sightseeing': 'üó∫Ô∏è', 'Curios': 'üëæ', 'Art': 'üé®', 'Activities': 'üö¥‚Äç‚ôÄÔ∏è', 'Chill': 'üå≥', 'Concert Venues': 'üé∏', 'Drinkplaces': 'üç∫', 'Touristy': 'üì∏', 'Eat': 'üçî', 'Default': 'üìç' };
    function getEmojiForCategory(category) { return categoryEmojis[category] || categoryEmojis['Default']; }
    function getCategoryClass(category) { return `category-${(category || 'Uncategorized').replace(/\s+/g, '')}`; }

    // --- CSV Parsing ---
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n'); if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase()); const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = []; let currentLine = lines[i]; let inQuotes = false; let currentValue = '';
            for (let j = 0; j < currentLine.length; j++) {
            const char = currentLine[j];
            if (char === '"') { if (inQuotes && currentLine[j + 1] === '"') { currentValue += '"'; j++; } else { inQuotes = !inQuotes; } }
            else if (char === ',' && !inQuotes) { values.push(currentValue.trim()); currentValue = ''; }
            else { currentValue += char; }
            }
            values.push(currentValue.trim());
            if (values.length === headers.length) {
            const entry = {}; headers.forEach((header, index) => {
                let val = values[index]; if (val.startsWith('"') && val.endsWith('"')) { val = val.substring(1, val.length - 1); }
                entry[header] = val.replace(/""/g, '"');
            }); data.push(entry);
            } else { console.warn(`Skipping malformed CSV line ${i + 1}`); }
        } return data;
    }

    // --- Load Data from CSV ---
    async function loadPlacesFromCSV(url) {
        try {
            const response = await fetch(url); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text(); const parsedData = parseCSV(csvText);
            return parsedData.map((item, index) => ({
                id: (item.name || `item-${index}`).replace(/[^a-zA-Z0-9-_]/g, '-').toLowerCase(),
                name: item.name || 'Unnamed Place', category: item.category || 'Uncategorized',
                description: item.description || '', emoji: getEmojiForCategory(item.category),
                categoryClass: getCategoryClass(item.category), originalIndex: index
            }));
        } catch (error) { console.error("Error loading/parsing CSV:", error); boardElement.innerHTML = `<div class="error-state"><i class="fas fa-exclamation-triangle"></i> Failed to load recommendations.</div>`; throw error; }
    }

    // --- Fetch Weather Data (Using WeatherAPI.com with Caching) ---
    async function fetchWeatherData() {
        // 1. Try loading from cache first
        try {
            const cachedDataJSON = localStorage.getItem(WEATHER_CACHE_KEY);
            if (cachedDataJSON) {
                const cachedData = JSON.parse(cachedDataJSON);
                const cacheAge = Date.now() - cachedData.timestamp;
                if (cacheAge < CACHE_EXPIRY_MS) {
                    console.log("Using cached weather data.");
                    return cachedData.data; // Return cached data if fresh
                } else {
                    console.log("Weather cache expired.");
                }
            }
        } catch (e) {
            console.error("Error reading weather cache:", e);
            localStorage.removeItem(WEATHER_CACHE_KEY); // Clear potentially corrupted cache
        }

        // 2. If cache is invalid or missing, fetch from API
        console.log("Fetching new weather data...");
        if (!WEATHERAPI_COM_KEY || WEATHERAPI_COM_KEY === "YOUR_WEATHERAPI_COM_KEY") { // Check for placeholder
            console.warn("WeatherAPI.com key not set.");
            updateWeatherDisplay(null); // Pass null to indicate key issue
            return null;
        }

        const today = new Date();
        const lastTripDate = new Date(TRIP_DATES[TRIP_DATES.length - 1] + 'T00:00:00');
        const diffTime = Math.abs(lastTripDate - today);
        const daysNeeded = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        const forecastDays = Math.min(daysNeeded, 10); // Limit to API max

        const url = `https://api.weatherapi.com/v1/forecast.json?key=${WEATHERAPI_COM_KEY}&q=${COPENHAGEN_LAT},${COPENHAGEN_LON}&days=${forecastDays}&aqi=no&alerts=no`;

        try {
            const response = await fetch(url);
            if (!response.ok) {
                const errorData = await response.json();
                if (response.status === 401 || response.status === 403) {
                     throw new Error(`WeatherAPI Auth Error (${response.status}): ${errorData.error.message}. Check your API key.`);
                } else {
                     throw new Error(`WeatherAPI Error (${response.status}): ${errorData.error.message}`);
                }
            }
            const data = await response.json();

            // Process the response
            const dailyWeather = {};
            if (data.forecast && data.forecast.forecastday) {
                data.forecast.forecastday.forEach(day => {
                    const dateStr = day.date;
                    if (TRIP_DATES.includes(dateStr)) {
                        dailyWeather[dateStr] = {
                            temp: Math.round(day.day.avgtemp_c),
                            description: day.day.condition.text,
                            icon: day.day.condition.icon.split('/').pop()
                        };
                    }
                });
            } else {
                console.warn("WeatherAPI response format unexpected:", data);
                return null;
            }

            // 3. Save successful fetch to cache
            try {
                const cachePayload = { data: dailyWeather, timestamp: Date.now() };
                localStorage.setItem(WEATHER_CACHE_KEY, JSON.stringify(cachePayload));
                console.log("Weather data cached.");
            } catch (e) { console.error("Error saving weather data to cache:", e); }

            return dailyWeather;

        } catch (error) {
            console.error("Error fetching WeatherAPI.com data:", error);
            updateWeatherDisplay(null); // Pass null to indicate fetch error
            return null;
        }
    }

    // --- Render UI Elements ---
    function createColumnElement(id, title) {
        const column = document.createElement('div'); column.className = 'board-column'; column.id = `column-${id}`;
        column.innerHTML = `<div class="column-header"><span class="column-title">${title}</span><div class="weather-info" id="weather-${id}"><span class="loading-state"><div class="spinner"></div></span></div></div><div class="column-list" id="list-${id}"></div>`;
        return column;
    }
    function createCardElement(place) {
        const card = document.createElement('div'); card.className = `recommendation-card ${place.categoryClass}`; card.dataset.id = place.id;
        card.innerHTML = `<div><div class="card-header"><span class="card-emoji">${place.emoji}</span><span class="card-name">${place.name}</span></div>${place.description ? `<p class="card-description">${place.description}</p>` : ''}</div>`;
        return card;
    }

    // --- Update Weather Display ---
    function updateWeatherDisplay(weatherData) {
        COLUMN_IDS_ORDER.forEach(id => {
            const weatherEl = document.getElementById(`weather-${id}`);
            if (!weatherEl || id === 'unassigned') return;

            let weatherHtml = '';
            const dayWeather = weatherData ? weatherData[id] : null;

            if (dayWeather) {
                 const iconUrl = `https://cdn.weatherapi.com/weather/64x64/day/${dayWeather.icon}`;
                 weatherHtml = `
                    <img src="${iconUrl}" alt="${dayWeather.description}" title="${dayWeather.description}">
                    <span>${dayWeather.temp}¬∞C</span>
                `;
            } else if (!WEATHERAPI_COM_KEY || WEATHERAPI_COM_KEY === "YOUR_WEATHERAPI_COM_KEY") {
                weatherHtml = '<i class="fas fa-key" title="API Key needed for weather"></i>';
            } else if (weatherData === null) { // Check if fetch failed overall
                 weatherHtml = '<i class="fas fa-exclamation-circle" title="Weather unavailable"></i>';
            } else {
                 weatherHtml = '<span>-</span>'; // No data specifically for this day
            }
            weatherEl.innerHTML = weatherHtml;
        });
    }

    // --- URL Hash State Persistence ---
    function saveBoardStateToURL() {
        let stateString = "";
        COLUMN_IDS_ORDER.forEach(columnId => {
            const listElement = document.getElementById(`list-${columnId}`);
            stateString += "&";
            if (listElement) {
                const itemIds = Array.from(listElement.querySelectorAll('.recommendation-card'))
                                     .map(card => card.dataset.id);
                itemIds.forEach(id => {
                    const index = placeIdToIndexMap[id];
                    if (index !== undefined) {
                        stateString += String(index).padStart(INDEX_PAD_LENGTH, '0');
                    } else { console.warn(`No index for card ID: ${id}`); }
                });
            }
        });

        try {
            const encodedState = btoa(stateString);
            history.replaceState(null, '', HASH_PREFIX + encodedState);
            updateShareBarURL(); // Update the displayed URL
            triggerShareBarShake(); // Trigger the animation
        } catch (e) { console.error("Failed to encode/set URL hash:", e); }
    }

    function loadBoardStateFromURL() {
        if (!window.location.hash || !window.location.hash.startsWith(HASH_PREFIX)) { return null; }
        try {
            const encodedState = window.location.hash.substring(HASH_PREFIX.length);
            const decodedState = atob(encodedState);
            const parts = decodedState.split('&').slice(1);
            if (parts.length !== COLUMN_IDS_ORDER.length) { console.error(`URL state parts mismatch. Expected ${COLUMN_IDS_ORDER.length}, got ${parts.length}`); return null; }
            const loadedState = {};
            parts.forEach((part, columnIndex) => {
                const columnId = COLUMN_IDS_ORDER[columnIndex];
                const listId = `list-${columnId}`;
                loadedState[listId] = [];
                for (let i = 0; i < part.length; i += INDEX_PAD_LENGTH) {
                    const indexStr = part.substring(i, i + INDEX_PAD_LENGTH);
                    const index = parseInt(indexStr, 10);
                    if (!isNaN(index) && index >= 0 && index < allPlacesData.length) {
                        loadedState[listId].push(allPlacesData[index].id);
                    } else { console.warn(`Invalid index ${indexStr} in URL state for column ${columnId}`); }
                }
            });
            return loadedState;
        } catch (e) { console.error("Failed to load/parse URL hash state:", e); return null; }
    }

    // --- Initialize SortableJS ---
    function initializeDragAndDrop() {
        const lists = document.querySelectorAll('.column-list');
        lists.forEach(list => {
            new Sortable(list, { group: 'shared', animation: 150, ghostClass: 'sortable-ghost', dragClass: 'sortable-drag', onEnd: saveBoardStateToURL });
        });
    }

    // --- Toggle Unassigned Column ---
    function toggleUnassigned() {
        const unassignedCol = document.getElementById('column-unassigned');
        if (unassignedCol) {
            isUnassignedVisible = !isUnassignedVisible;
            unassignedCol.classList.toggle('hidden', !isUnassignedVisible);
            const buttonTextSpan = toggleButton.querySelector('span');
            const buttonIcon = toggleButton.querySelector('i');
            if (isUnassignedVisible) {
                buttonTextSpan.textContent = "Hide Mattia's Tips";
                buttonIcon.className = 'fas fa-eye-slash';
            } else {
                buttonTextSpan.textContent = "Show Mattia's Tips";
                buttonIcon.className = 'fas fa-lightbulb';
            }
            boardElement.classList.toggle('columns-3', !isUnassignedVisible);
            boardElement.classList.toggle('columns-4', isUnassignedVisible);
        }
    }

    // --- Populate Board from State or Default ---
    function populateBoard(initialState) {
        const allItemIds = new Set(allPlacesData.map(p => p.id));
        const placedItemIds = new Set();
        if (initialState) {
            Object.entries(initialState).forEach(([listId, itemIds]) => {
                const listElement = document.getElementById(listId);
                if (listElement) {
                    itemIds.forEach(itemId => {
                        if (cardElements[itemId]) {
                            listElement.appendChild(cardElements[itemId]);
                            placedItemIds.add(itemId);
                        } else { console.warn(`Card ID ${itemId} not found.`); }
                    });
                } else { console.warn(`List ID ${listId} not found.`); }
            });
        }
        const unassignedList = document.getElementById('list-unassigned');
        if (unassignedList) {
            allItemIds.forEach(itemId => {
                if (!placedItemIds.has(itemId) && cardElements[itemId]) {
                    unassignedList.appendChild(cardElements[itemId]);
                }
            });
        } else { console.error("Unassigned list not found."); }
    }

    // --- Update Share Bar ---
    function updateShareBarURL() {
        const shareUrlInput = document.getElementById('share-url-input');
        if (shareUrlInput) {
            shareUrlInput.value = window.location.href;
        }
    }

    // --- Trigger Shake Animation ---
    function triggerShareBarShake() {
        const shareBar = document.getElementById('share-bar');
        if (shareBar) {
            shareBar.classList.remove('shake-effect');
            void shareBar.offsetWidth; // Trigger reflow to restart animation
            shareBar.classList.add('shake-effect');
        }
    }

    // --- Main Initialization ---
    async function initializeApp() {
      try {
        // 1. Load data and weather concurrently
        const [places, weatherData] = await Promise.all([
          loadPlacesFromCSV('copenhagen_places.csv'),
          fetchWeatherData()
        ]);
        allPlacesData = places;

        // Create map for quick ID -> Index lookup
        placeIdToIndexMap = {};
        allPlacesData.forEach((place, index) => { placeIdToIndexMap[place.id] = index; });

        // Clear loading state
        boardElement.innerHTML = '';

        // 2. Create all card elements
        cardElements = {};
        allPlacesData.forEach(place => { cardElements[place.id] = createCardElement(place); });

        // 3. Create Columns
        COLUMN_IDS_ORDER.forEach(id => {
            let title = "Mattia's Tips";
            if (id !== 'unassigned') {
                const dateObj = new Date(id + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                title = `${dayName}, ${monthDay}`;
            }
            const column = createColumnElement(id, title);
            if (id === 'unassigned') { column.classList.add('hidden'); }
            boardElement.appendChild(column);
        });
        boardElement.classList.add('columns-3');

        // 4. Update weather display
        updateWeatherDisplay(weatherData);

        // 5. Load state from URL or default
        let initialState = loadBoardStateFromURL();
        if (!initialState) {
            initialState = { [`list-unassigned`]: allPlacesData.map(p => p.id) };
            COLUMN_IDS_ORDER.slice(1).forEach(id => initialState[`list-${id}`] = []);
        }
        populateBoard(initialState);

        // Update share bar with initial URL
        updateShareBarURL();

        // 6. Initialize Drag and Drop
        initializeDragAndDrop();

        // 7. Setup Toggle Button Listener & Initial Text
        toggleButton.addEventListener('click', toggleUnassigned);
        toggleButton.querySelector('span').textContent = "Show Mattia's Tips";
        toggleButton.querySelector('i').className = 'fas fa-lightbulb';

        // 8. Setup Copy Button Listener
        const copyUrlBtn = document.getElementById('copy-url-btn');
        const shareUrlInput = document.getElementById('share-url-input');
        const copyConfirm = document.getElementById('copy-confirmation');

        copyUrlBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(shareUrlInput.value);
                copyConfirm.textContent = 'Copied!';
                copyConfirm.classList.add('visible');
                setTimeout(() => { copyConfirm.classList.remove('visible'); }, 2000);
            } catch (err) {
                console.error('Failed to copy URL: ', err);
                copyConfirm.textContent = 'Copy failed';
                copyConfirm.classList.add('visible');
                setTimeout(() => { copyConfirm.classList.remove('visible'); }, 2000);
            }
        });

        // 9. Save initial state to URL if needed (ensures bar is correct on first load)
        if (!window.location.hash.startsWith(HASH_PREFIX)) {
            saveBoardStateToURL(); // This will also call updateShareBarURL and shake
        }

      } catch (error) {
        console.error("Initialization failed:", error);
      }
    }

    // --- Start the app ---
    document.addEventListener('DOMContentLoaded', initializeApp);

  </script>
</body>
</html>
